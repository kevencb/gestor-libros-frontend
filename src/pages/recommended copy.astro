---
import "/src/styles/global.css";
import Header from "../components/Header.astro";
---

<Header />

<main class="container">
  <h1>Recomendados del Mes</h1>
  <div id="booksGrid" class="book-grid"></div>
</main>

<script type="module">
  import { fetchBooks, addFavorite } from "/src/lib/api.js";

  const grid = document.getElementById("booksGrid");

  // Normalizador seguro del campo "recommended"
  function isRecommended(v) {
    if (v === true) return true;
    if (v === 1) return true;
    if (typeof v === "string") {
      const s = v.toLowerCase();
      return s === "true" || s === "1" || s === "yes" || s === "on";
    }
    return false;
  }

  async function load() {
    try {
      let allBooks = await fetchBooks();
      console.log("üìö raw fetchBooks():", allBooks);

      // Si vino como { data: [...] }
      if (!Array.isArray(allBooks)) {
        if (allBooks && Array.isArray(allBooks.data)) {
          allBooks = allBooks.data;
          console.log("Desempaquetado desde .data");
        }
        if (allBooks && Array.isArray(allBooks.books)) {
          allBooks = allBooks.books;
          console.log("Desempaquetado desde .books");
        }
      }

      if (!Array.isArray(allBooks)) {
        console.warn("fetchBooks() NO devolvi√≥ array");
        grid.innerHTML = "<p>No se pudieron cargar los libros.</p>";
        return;
      }

      // Mostrar cada item para depurar
      allBooks.forEach((b, i) => {
        console.log(
          "ITEM",
          i,
          "id=",
          b._id,
          "recommended=",
          b.recommended,
          "typeof=",
          typeof b.recommended
        );
      });

      // Filtrado seguro
      const recommended = allBooks.filter((b) => isRecommended(b.recommended));
      console.log("‚≠ê recommended:", recommended);

      grid.innerHTML = "";

      if (recommended.length === 0) {
        grid.innerHTML = "<p>A√∫n no hay libros recomendados.</p>";
        return;
      }

      recommended.forEach((b) => {
        const div = document.createElement("div");
        div.className = "card";

        const cover = b.coverImage || b.cover || "";
        const id = b._id || b.id || "";

        div.innerHTML =
          '<img src="' +
          cover +
          '">' +
          "<span>" +
          (b.genre || "") +
          "</span>" +
          "<h2>" +
          (b.title || "") +
          "</h2>" +
          "<h3>" +
          (b.author || "") +
          "</h3>" +
          '<div class="card-button-container">' +
          '<button class="btn btn-info seeDetail" data-id="' +
          id +
          '">Conoce m√°s</button>' +
          '<button class="btn addBtn btn-favorite">‚≠ê</button>' +
          "</div>";

        // Bot√≥n detalle
        div.querySelector(".seeDetail").addEventListener("click", (e) => {
          const bid = e.currentTarget.dataset.id;
          window.location.href = "/books/" + bid;
        });

        // Bot√≥n favorito
        div.querySelector(".addBtn").addEventListener("click", async () => {
          const user = JSON.parse(localStorage.getItem("user") || "null");
          if (!user || !user.token) {
            const go = confirm(
              "Debes iniciar sesi√≥n para agregar a tu lista. ¬øIr a login?"
            );
            if (go) window.location.href = "/login";
            return;
          }

          try {
            const res = await addFavorite(user.token, id);
            alert(res?.msg || "Agregado");
          } catch (err) {
            alert("No se pudo agregar a favoritos");
          }
        });

        grid.appendChild(div);
      });
    } catch (err) {
      console.error("ERROR load():", err);
      grid.innerHTML = "<p>Error cargando libros.</p>";
    }
  }

  load();
</script>
